import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

const HOSTEDSCAN_BASE = "https://api.hostedscan.com/v1";

async function hostedscanFetch(path: string, options: RequestInit = {}) {
  const apiKey = Deno.env.get("HOSTEDSCAN_API_KEY");
  if (!apiKey) throw new Error("HOSTEDSCAN_API_KEY is not configured");

  const res = await fetch(`${HOSTEDSCAN_BASE}${path}`, {
    ...options,
    headers: {
      "X-HOSTEDSCAN-API-KEY": apiKey,
      "Content-Type": "application/json",
      ...(options.headers || {}),
    },
  });

  if (!res.ok) {
    const text = await res.text();
    console.error(`HostedScan API error [${res.status}]:`, text);
    throw new Error(`HostedScan API error: ${res.status} - ${text}`);
  }

  return res.json();
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const url = new URL(req.url);
    const action = url.searchParams.get("action");

    // ACTION: start-scan — creates and starts an NMAP scan
    if (action === "start-scan" && req.method === "POST") {
      const { target } = await req.json();
      if (!target || typeof target !== "string") {
        return new Response(
          JSON.stringify({ error: "Target is required" }),
          { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }

      // Validate target format (IP or domain)
      const targetClean = target.trim().replace(/^https?:\/\//, "").replace(/\/.*$/, "");
      if (!/^[a-zA-Z0-9][a-zA-Z0-9.\-]+[a-zA-Z0-9]$/.test(targetClean)) {
        return new Response(
          JSON.stringify({ error: "Invalid target format. Use IP or domain (e.g., 192.168.1.1 or example.com)" }),
          { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }

      // Start NMAP scan
      const scanData = await hostedscanFetch("/scans", {
        method: "POST",
        body: JSON.stringify({
          type: "NMAP",
          targets: [targetClean],
        }),
      });

      return new Response(
        JSON.stringify({ scan_id: scanData.id, status: scanData.state, target: targetClean }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // ACTION: scan-status — polls scan state
    if (action === "scan-status") {
      const scanId = url.searchParams.get("scan_id");
      if (!scanId) {
        return new Response(
          JSON.stringify({ error: "scan_id is required" }),
          { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }

      const scanData = await hostedscanFetch(`/scans/${scanId}`);
      return new Response(
        JSON.stringify({
          scan_id: scanData.id,
          status: scanData.state,
          progress: scanData.progress,
          type: scanData.type,
          created_at: scanData.created_at,
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // ACTION: scan-results — gets risks for a completed scan
    if (action === "scan-results") {
      const scanId = url.searchParams.get("scan_id");
      if (!scanId) {
        return new Response(
          JSON.stringify({ error: "scan_id is required" }),
          { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }

      const risks = await hostedscanFetch(`/risks?scan_id=${scanId}`);
      const scanData = await hostedscanFetch(`/scans/${scanId}`);

      return new Response(
        JSON.stringify({
          scan: scanData,
          risks: risks,
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    return new Response(
      JSON.stringify({ error: "Unknown action. Use: start-scan, scan-status, scan-results" }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (e) {
    console.error("vulnerability-scan error:", e);
    return new Response(
      JSON.stringify({ error: e instanceof Error ? e.message : "Unknown error" }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
